<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="-1">
    <title>Payment Successful - HexAI WiFi</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="octalink-bg">
    <div class="octalink-flex">
        <div class="octalink-card" style="max-width: 500px; margin: 40px auto;">
            <div class="octalink-card-header">
                <span class="macos-dot red"></span>
                <span class="macos-dot yellow"></span>
                <span class="macos-dot green"></span>
            </div>
            <div class="octalink-logo" style="display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 18px;">
                <svg viewBox="0 0 24 24" class="wifi-icon" style="width:48px; height:48px;"><path d="M12,3L2,12H5V20H11V14H13V20H19V12H22L12,3M12,7.7C14.1,7.7 15.8,9.4 15.8,11.5C15.8,13.6 14.1,15.3 12,15.3C9.9,15.3 8.2,13.6 8.2,11.5C8.2,9.4 9.9,7.7 12,7.7Z" fill="#fff"/></svg>
                <span class="brand-name" style="font-size:2rem; font-weight:700; color:#fff; letter-spacing:1px;">HexAI WiFi</span>
            </div>
            
            <div id="loadingState" style="text-align: center;">
                <div class="hexai-spinner" style="margin: 30px auto;"></div>
                <p class="octalink-subtitle">Processing your payment...</p>
            </div>

            <div id="successState" style="display: none;">
                <div class="success-icon" style="text-align: center; margin-bottom: 20px;">
                    <svg viewBox="0 0 24 24" width="80" height="80" fill="#4CAF50">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                </div>
                
                <h2 class="octalink-title" style="color: #4CAF50;">Payment Successful!</h2>
                <p class="octalink-subtitle">Your WiFi voucher is ready.</p>
                
                <div class="payment-info-box" style="margin: 20px 0;">
                    <div style="text-align: center; padding: 20px;">
                        <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 8px;">Your Voucher Code</div>
                        <div id="voucherCode" style="font-size: 1.5rem; font-weight: 700; color: #fff; font-family: 'Courier New', monospace; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin: 10px 0; word-break: break-all;">
                            ••••••••
                        </div>
                        <button onclick="copyVoucher()" class="octalink-btn-secondary" style="margin-top: 10px;">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 6px;">
                                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                            Copy Code
                        </button>
                    </div>
                </div>

                <div class="info" style="background: rgba(29, 201, 255, 0.1); border: 1px solid rgba(29, 201, 255, 0.3); border-radius: 12px; padding: 15px; margin: 15px 0;">
                    <div style="font-weight: 600; color: #fff; margin-bottom: 8px;">Package Details:</div>
                    <div id="packageInfo" style="color: rgba(255,255,255,0.8); font-size: 0.9rem;">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div id="loginSection" style="display: none;">
                    <form id="autoLoginForm" action="" method="post" style="display: none;">
                        <input type="hidden" name="username" id="loginUsername" value="">
                        <input type="hidden" name="password" id="loginPassword" value="">
                        <input type="hidden" name="dst" id="loginDst" value="">
                    </form>
                    <button onclick="loginToWiFi()" class="octalink-btn-primary" style="width: 100%; margin-top: 15px;">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="margin-right: 8px;">
                            <path d="M1 9l2 2c4.97-4.97 13.03-4.97 18 0l2-2C16.93 2.93 7.08 2.93 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z"/>
                        </svg>
                        Connect to WiFi Now
                    </button>
                </div>

                <div id="manualLoginSection">
                    <p class="info" style="text-align: center; margin-top: 20px; color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                        Go to the <a href="login-gambia.html" style="color: #4eaaff; text-decoration: underline;">login page</a> and enter your voucher code to connect.
                    </p>
                </div>
            </div>

            <div id="errorState" style="display: none; text-align: center;">
                <div style="margin-bottom: 20px;">
                    <svg viewBox="0 0 24 24" width="80" height="80" fill="#f44336">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                </div>
                <h2 class="octalink-title" style="color: #f44336;">Payment Verification Failed</h2>
                <p class="octalink-subtitle" id="errorMessage">Unable to retrieve voucher. Please contact support.</p>
                <a href="tarifs-gambia.html" class="octalink-btn-secondary" style="display: inline-block; margin-top: 20px;">
                    Back to Packages
                </a>
            </div>
        </div>
    </div>
    
    <script src="conf-gambia.js"></script>
    <script src="js/mikrotik-helper.js"></script>
    <script src="js/theme-toggle.js"></script>
    <script type="text/javascript">
        let voucherData = null;
        let deviceInfo = null;

        // Check for payment data in sessionStorage or URL parameters
        async function loadPaymentData() {
            try {
                // Log Wave redirect parameters
                const urlParams = new URLSearchParams(window.location.search);
                const allParams = {};
                for (const [key, value] of urlParams.entries()) {
                    allParams[key] = value;
                }
                
                console.log('=== WAVE SUCCESS REDIRECT DEBUG ===');
                console.log('URL:', window.location.href);
                console.log('Parameters:', allParams);
                console.log('Hash:', window.location.hash);
                console.log('Timestamp:', new Date().toISOString());
                console.log('================================');
                
                // Send to backend for logging
                fetch('/api/log-redirect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        page: 'success',
                        url: window.location.href,
                        params: allParams,
                        timestamp: new Date().toISOString()
                    })
                }).catch(e => console.error('Failed to send log:', e));

                // Try to get payment info from URL parameters (Wave redirect)
                // Wave redirects with our appended reference parameter
                const reference = urlParams.get('reference') || 
                                 urlParams.get('client_reference') ||
                                 urlParams.get('transaction_id') || 
                                 urlParams.get('id');
                
                if (reference) {
                    // Query backend for payment status
                    console.log('Fetching payment status for reference:', reference);
                    const response = await fetch(`/api/payment/status/${reference}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch payment status');
                    }
                    const result = await response.json();
                    
                    if (result.status === 'success' && result.data) {
                        // Map API response to our payment data format
                        const apiData = result.data;
                        const packageInfo = result.data.package_info;
                        
                        voucherData = {
                            packageType: packageInfo?.package_type || 'unknown',
                            packageName: packageInfo?.package_name || 'WiFi Package',
                            amount: packageInfo?.amount || '0',
                            reference: reference,
                            voucherCode: packageInfo?.voucher_code || null,
                            status: apiData.status
                        };
                    } else {
                        throw new Error('Payment not found or failed');
                    }
                } else {
                    // Fallback to sessionStorage
                    const paymentStr = sessionStorage.getItem('hexai_payment');
                    if (!paymentStr) {
                        throw new Error('No payment data found in URL or sessionStorage');
                    }
                    const payment = JSON.parse(paymentStr);
                    voucherData = payment;
                }

                // Get device info if available
                if (typeof MikroTikHelper !== 'undefined') {
                    deviceInfo = MikroTikHelper.getDeviceInfo();
                }

                // Display success
                showSuccess(voucherData);

            } catch (error) {
                console.error('Error loading payment:', error);
                showError(error.message);
            }
        }

        function showSuccess(payment) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('successState').style.display = 'block';

            // Generate or retrieve voucher code
            let voucher = payment.voucherCode;
            if (!voucher && typeof MikroTikHelper !== 'undefined') {
                voucher = MikroTikHelper.generateVoucherCode(payment.packageType, deviceInfo?.mac);
            }
            if (!voucher) {
                voucher = `${payment.packageType.toUpperCase()}-${Date.now().toString(36).toUpperCase()}`;
            }

            // Display voucher
            document.getElementById('voucherCode').textContent = voucher;
            voucherData.voucherCode = voucher;

            // Display package info
            const packageInfo = `
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <span>Package:</span> <strong>${payment.packageName || payment.packageType}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <span>Amount:</span> <strong>D${payment.amount}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                    <span>Reference:</span> <strong>${payment.reference}</strong>
                </div>
            `;
            document.getElementById('packageInfo').innerHTML = packageInfo;

            // Setup auto-login if on MikroTik hotspot
            if (deviceInfo && deviceInfo.linkLoginUrl) {
                setupAutoLogin(voucher);
            }

            // Store voucher for later use
            if (typeof MikroTikHelper !== 'undefined') {
                MikroTikHelper.storeVoucher({
                    code: voucher,
                    package: payment.packageName,
                    amount: payment.amount
                });
            }
        }

        function setupAutoLogin(voucher) {
            const loginSection = document.getElementById('loginSection');
            const manualSection = document.getElementById('manualLoginSection');
            
            // Setup form
            const form = document.getElementById('autoLoginForm');
            form.action = deviceInfo.linkLoginUrl;
            document.getElementById('loginUsername').value = voucher;
            document.getElementById('loginPassword').value = voucher;
            document.getElementById('loginDst').value = deviceInfo.linkOrig || '';

            // Show auto-login button
            loginSection.style.display = 'block';
            manualSection.style.display = 'none';
        }

        function loginToWiFi() {
            // Submit the auto-login form
            document.getElementById('autoLoginForm').submit();
        }

        function copyVoucher() {
            const voucherCode = document.getElementById('voucherCode').textContent;
            
            // Copy to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(voucherCode).then(() => {
                    // Show feedback
                    const btn = event.target.closest('button');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 6px;"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Copied!';
                    btn.style.background = 'rgba(76, 175, 80, 0.2)';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.style.background = '';
                    }, 2000);
                });
            }
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // Load payment data on page load
        window.addEventListener('DOMContentLoaded', loadPaymentData);

        // Set theme
        var bodyclass = document.getElementsByTagName("body")[0];
        if (typeof config !== 'undefined' && config["theme"] == "dark") {
            bodyclass.classList.add("dark");
        } else if (typeof config !== 'undefined' && config["theme"] == "lite") {
            bodyclass.classList.add("lite");
        }
    </script>

    <style>
        .payment-info-box {
            background: rgba(29, 201, 255, 0.1);
            border: 1px solid rgba(29, 201, 255, 0.3);
            border-radius: 12px;
        }
        
        .hexai-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #1DC9FF;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>

</html>
